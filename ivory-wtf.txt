https://github.com/Hodapp87/ivory/tree/stack-ghci
https://github.com/GaloisInc/ivory/issues/56

Is this related?
http://stackoverflow.com/questions/19622537/running-ghci-on-a-module-that-needs-language-cpp

-----------------------------------------------------------------------------
Modified stack.yaml:
-----------------------------------------------------------------------------
flags: {}
packages:
- ivory-stdlib/
#- ivory-model-check/
- ivory-opts/
#- ivory-examples/
#- ivory-backend-acl2/
- ivory-serialize/
- ivory/
- ivory-hw/
#- ivory-eval/
- ivory-backend-c/
#- ivory-quickcheck/
- ivory-artifact/
extra-deps:
- acl2-0.0.1
- ghc-srcspan-plugin-0.2.1.0
resolver: lts-2.21

-----------------------------------------------------------------------------
Running 'stack ghci':
-----------------------------------------------------------------------------
Configuring GHCi with the following packages: ivory-artifact, ivory-backend-c, ivory-hw, ivory-opts, ivory-serialize, ivory-stdlib, ivory
GHCi, version 7.8.4: http://www.haskell.org/ghc/  :? for help

...

[  1 of 109] Compiling Paths_ivory_hw   ( /home/hodapp/source/ivory/ivory-hw/.stack-work/dist/x86_64-linux/Cabal-1.18.1.5/build/autogen/Paths_ivory_hw.hs, interpreted )
[  2 of 109] Compiling Ivory.HW.IOArea  ( /home/hodapp/source/ivory/ivory-hw/src/Ivory/HW/IOArea.hs, interpreted )
[  3 of 109] Compiling Paths_ivory_backend_c ( /home/hodapp/source/ivory/ivory-backend-c/.stack-work/dist/x86_64-linux/Cabal-1.18.1.5/build/autogen/Paths_ivory_backend_c.hs, interpreted )
[  4 of 109] Compiling Ivory.Compile.C.CmdlineFrontend.Options ( /home/hodapp/source/ivory/ivory-backend-c/src/Ivory/Compile/C/CmdlineFrontend/Options.hs, interpreted )
[  5 of 109] Compiling Ivory.Compile.C.Types ( /home/hodapp/source/ivory/ivory-backend-c/src/Ivory/Compile/C/Types.hs, interpreted )
[  6 of 109] Compiling Paths_ivory_serialize ( /home/hodapp/source/ivory/ivory-serialize/.stack-work/dist/x86_64-linux/Cabal-1.18.1.5/build/autogen/Paths_ivory_serialize.hs, interpreted )
[  7 of 109] Compiling Paths_ivory_stdlib ( /home/hodapp/source/ivory/ivory-stdlib/.stack-work/dist/x86_64-linux/Cabal-1.18.1.5/build/autogen/Paths_ivory_stdlib.hs, interpreted )
[  8 of 109] Compiling Ivory.Language.Syntax.Names ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Names.hs, interpreted )
[  9 of 109] Compiling Ivory.Language.Syntax.Type ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Type.hs, interpreted )
[ 10 of 109] Compiling Ivory.Language.Syntax.Concrete.Pretty ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/Pretty.hs, interpreted )
[ 11 of 109] Compiling Ivory.Language.Syntax.Concrete.Location ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/Location.hs, interpreted )
[ 12 of 109] Compiling Ivory.Language.Syntax.Concrete.ParseAST ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/ParseAST.hs, interpreted )
[ 13 of 109] Compiling Ivory.Language.Syntax.Concrete.QQ.Common ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/QQ/Common.hs, interpreted )
[ 14 of 109] Compiling Ivory.Language.Syntax.AST ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/AST.hs, interpreted )

/home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/AST.hs:446:10:
    Duplicate instance declarations:
      instance Lift Double
        -- Defined at /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/AST.hs:446:10
      instance Lift Double
        -- Defined in ‘th-orphans-0.11.1:Language.Haskell.TH.Instances’

/home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/AST.hs:449:10:
    Duplicate instance declarations:
      instance Lift Float
        -- Defined at /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/AST.hs:449:10
      instance Lift Float
        -- Defined in ‘th-orphans-0.11.1:Language.Haskell.TH.Instances’
Failed, modules loaded: Ivory.Language.Syntax.Concrete.Location, Ivory.Language.Syntax.Concrete.ParseAST, Ivory.Language.Syntax.Concrete.Pretty, Ivory.Language.Syntax.Concrete.QQ.Common, Ivory.Language.Syntax.Type, Ivory.Language.Syntax.Names, Paths_ivory_stdlib, Paths_ivory_serialize, Ivory.Compile.C.Types, Ivory.Compile.C.CmdlineFrontend.Options, Paths_ivory_backend_c, Ivory.HW.IOArea, Paths_ivory_hw.
*Ivory.Compile.C.CmdlineFrontend.Options>

-----------------------------------------------------------------------------
The offending section of code:
-----------------------------------------------------------------------------
#if __GLASGOW_HASKELL__ < 709
instance Lift Double where
  lift = lift . toRational

instance Lift Float where
  lift = lift . toRational
#endif

-----------------------------------------------------------------------------
If I disable that (but do not run 'stack build') and then run 'stack ghci':
-----------------------------------------------------------------------------
...
[ 12 of 109] Compiling Ivory.Language.Syntax.Concrete.Location ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/Location.hs, interpreted )
[ 13 of 109] Compiling Ivory.Language.Syntax.Concrete.Lexeme ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/Lexeme.hs, interpreted )
[ 14 of 109] Compiling Ivory.Language.Syntax.Concrete.Lexer ( /home/hodapp/source/ivory/ivory/.stack-work/dist/x86_64-linux/Cabal-1.18.1.5/build/Ivory/Language/Syntax/Concrete/Lexer.hs, interpreted )

templates/GenericTemplate.hs:205:10: Warning:
    Defined but not used: ‘f’

templates/GenericTemplate.hs:207:10: Warning:
    Defined but not used: ‘f’
[ 15 of 109] Compiling Ivory.Language.Syntax.Concrete.ParseAST ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/ParseAST.hs, interpreted )
[ 16 of 109] Compiling Ivory.Language.Syntax.Concrete.QQ.Common ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/QQ/Common.hs, interpreted )
[ 17 of 109] Compiling Ivory.Language.Syntax.Concrete.ParseCore ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/Concrete/ParseCore.hs, interpreted )
[ 18 of 109] Compiling Ivory.Language.Syntax.Concrete.Parser ( /home/hodapp/source/ivory/ivory/.stack-work/dist/x86_64-linux/Cabal-1.18.1.5/build/Ivory/Language/Syntax/Concrete/Parser.hs, interpreted )
[ 19 of 109] Compiling Ivory.Language.Syntax.AST ( /home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/AST.hs, interpreted )

/home/hodapp/source/ivory/ivory/src/Ivory/Language/Syntax/AST.hs:433:1:
    No instance for (Lift Float) arising from a use of ‘lift’
    In the second argument of ‘Language.Haskell.TH.Lib.appE’, namely
      ‘lift x0’
    In the expression:
      Language.Haskell.TH.Lib.appE
        (Language.Haskell.TH.Lib.conE
           (Language.Haskell.TH.Syntax.Name
              (Language.Haskell.TH.Syntax.mkOccName "LitFloat")
              (Language.Haskell.TH.Syntax.NameG
                 Language.Haskell.TH.Syntax.DataName
                 (Language.Haskell.TH.Syntax.mkPkgName "main")
                 (Language.Haskell.TH.Syntax.mkModName
                    "Ivory.Language.Syntax.AST"))))
        (lift x0)
    In an equation for ‘lift’:
        lift (LitFloat x0)
          = Language.Haskell.TH.Lib.appE
              (Language.Haskell.TH.Lib.conE
                 (Language.Haskell.TH.Syntax.Name
                    (Language.Haskell.TH.Syntax.mkOccName "LitFloat")
                    (Language.Haskell.TH.Syntax.NameG
                       Language.Haskell.TH.Syntax.DataName
                       (Language.Haskell.TH.Syntax.mkPkgName "main")
                       (Language.Haskell.TH.Syntax.mkModName
                          "Ivory.Language.Syntax.AST"))))
              (lift x0)
Failed, modules loaded: Ivory.Language.Syntax.Concrete.Pretty, Ivory.HW.IOArea, Paths_ivory_hw, Ivory.Language.Syntax.Type, Ivory.Language.Syntax.Names, Ivory.Language.Syntax.Concrete.Location, Ivory.Language.Proxy, Paths_ivory_serialize, Paths_ivory_stdlib, Ivory.Language.Effects, Ivory.Language.Scope, Ivory.Language.BitData.DefBitRep, Ivory.Language.Syntax.Concrete.Lexeme, Ivory.Language.Syntax.Concrete.Lexer, Ivory.Language.Syntax.Concrete.ParseAST, Ivory.Language.Syntax.Concrete.ParseCore, Ivory.Language.Syntax.Concrete.Parser, Ivory.Language.Syntax.Concrete.QQ.Common.
*Ivory.HW.IOArea>

-----------------------------------------------------------------------------
If I re-run 'stack build' after this:
-----------------------------------------------------------------------------

...
    src/Ivory/Language/Syntax/AST.hs:433:1:
        No instance for (Lift Float) arising from a use of ‘lift’
        In the second argument of ‘Language.Haskell.TH.Lib.appE’, namely
          ‘lift x0’
        In the expression:
          Language.Haskell.TH.Lib.appE
            (Language.Haskell.TH.Lib.conE
               (Language.Haskell.TH.Syntax.Name
                  (Language.Haskell.TH.Syntax.mkOccName "LitFloat")
                  (Language.Haskell.TH.Syntax.NameG
                     Language.Haskell.TH.Syntax.DataName
                     (Language.Haskell.TH.Syntax.mkPkgName "ivory-0.1.0.2")
                     (Language.Haskell.TH.Syntax.mkModName
                        "Ivory.Language.Syntax.AST"))))
            (lift x0)
        In an equation for ‘lift’:
            lift (LitFloat x0)
              = Language.Haskell.TH.Lib.appE
                  (Language.Haskell.TH.Lib.conE
                     (Language.Haskell.TH.Syntax.Name
                        (Language.Haskell.TH.Syntax.mkOccName "LitFloat")
                        (Language.Haskell.TH.Syntax.NameG
                           Language.Haskell.TH.Syntax.DataName
                           (Language.Haskell.TH.Syntax.mkPkgName "ivory-0.1.0.2")
                           (Language.Haskell.TH.Syntax.mkModName
                              "Ivory.Language.Syntax.AST"))))
                  (lift x0)
